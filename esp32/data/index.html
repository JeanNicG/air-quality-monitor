<!DOCTYPE html>
<html>
<head>
    <title>Air Quality Monitor</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Air Quality Monitor</h1>
            <div class="status" id="status">Loading...</div>
        </header>
        
        <div class="grid">
            <div class="card" id="co2-card">
                <div class="card-header">
                    <h3>CO2</h3>
                </div>
                <div class="value" id="co2">-</div>
                <div class="unit">ppm</div>
                <div class="quality" id="co2-quality">-</div>
            </div>
            
            <div class="card" id="pm25-card">
                <div class="card-header">
                    <h3>PM2.5</h3>
                </div>
                <div class="value" id="pm25">-</div>
                <div class="unit">µg/m³</div>
                <div class="quality" id="pm25-quality">-</div>
            </div>
            
            <div class="card" id="o3-card">
                <div class="card-header">
                    <h3>Ozone</h3>
                </div>
                <div class="value" id="o3">-</div>
                <div class="unit">ppb</div>
                <div class="quality" id="o3-quality">-</div>
            </div>
            
            <div class="card" id="temp-card">
                <div class="card-header">
                    <h3>Temperature</h3>
                </div>
                <div class="value" id="temp">-</div>
                <div class="unit">°C</div>
                <div class="quality" id="temp-quality">-</div>
            </div>
            
            <div class="card" id="hum-card">
                <div class="card-header">
                    <h3>Humidity</h3>
                </div>
                <div class="value" id="hum">-</div>
                <div class="unit">%</div>
                <div class="quality" id="hum-quality">-</div>
            </div>
            
            <div class="card" id="tvoc-card">
                <div class="card-header">
                    <h3>TVOC</h3>
                </div>
                <div class="value" id="tvoc">-</div>
                <div class="unit">raw</div>
                <div class="quality" id="tvoc-quality">-</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-container">
                <h3>CO2 Levels</h3>
                <canvas id="co2Chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>PM2.5 Levels</h3>
                <canvas id="pm25Chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Ozone Levels</h3>
                <canvas id="o3Chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Temperature</h3>
                <canvas id="tempChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Humidity</h3>
                <canvas id="humChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>TVOC Levels</h3>
                <canvas id="tvocChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let dataPoints = {
            co2: [],
            pm25: [],
            o3: [],
            temp: [],
            hum: [],
            tvoc: [],
            timestamps: []
        };
        
        // Air quality thresholds and color functions
        function getAirQualityColor(sensor, value) {
            let level = getAirQualityLevel(sensor, value);
            switch(level) {
                case 'Good': return '#28a745';
                case 'Moderate': return '#ffc107';
                case 'Sensitive': return '#fd7e14';
                case 'Unhealthy': return '#dc3545';
                case 'Hazardous': return '#6f42c1';
                default: return '#6c757d';
            }
        }
        
        function getAirQualityLevel(sensor, value) {
            if (value <= 0) return '-';
            
            switch(sensor) {
                case 'co2':
                    if (value <= 400) return 'Good';
                    if (value <= 1000) return 'Moderate';
                    if (value <= 2000) return 'Sensitive';
                    if (value <= 5000) return 'Unhealthy';
                    return 'Hazardous';
                
                case 'pm25':
                    if (value <= 12) return 'Good';
                    if (value <= 35) return 'Moderate';
                    if (value <= 55) return 'Sensitive';
                    if (value <= 150) return 'Unhealthy';
                    return 'Hazardous';
                
                case 'o3':
                    if (value <= 54) return 'Good';
                    if (value <= 70) return 'Moderate';
                    if (value <= 85) return 'Sensitive';
                    if (value <= 105) return 'Unhealthy';
                    return 'Hazardous';
                
                case 'temp':
                    if (value >= 18 && value <= 24) return 'Good';
                    if (value >= 15 && value <= 27) return 'Moderate';
                    if (value >= 12 && value <= 30) return 'Sensitive';
                    if (value >= 10 && value <= 35) return 'Unhealthy';
                    return 'Hazardous';
                
                case 'hum':
                    if (value >= 40 && value <= 60) return 'Good';
                    if (value >= 30 && value <= 70) return 'Moderate';
                    if (value >= 25 && value <= 75) return 'Sensitive';
                    if (value >= 20 && value <= 80) return 'Unhealthy';
                    return 'Hazardous';
                
                case 'tvoc':
                    if (value <= 65) return 'Good';
                    if (value <= 220) return 'Moderate';
                    if (value <= 660) return 'Sensitive';
                    if (value <= 2200) return 'Unhealthy';
                    return 'Hazardous';
                
                default:
                    return '-';
            }
        }
        
        function updateSensorDisplay(sensor, value) {
            const level = getAirQualityLevel(sensor, value);
            const color = getAirQualityColor(sensor, value);
            
            document.getElementById(sensor).textContent = value;
            document.getElementById(sensor + '-quality').textContent = level;
            document.getElementById(sensor).style.color = color;
            document.getElementById(sensor + '-quality').style.color = color;
        }
        
        // Initialize individual charts
        function initCharts() {
            const sensors = [
                { id: 'co2', label: 'CO2 (ppm)', color: 'rgb(255, 99, 132)' },
                { id: 'pm25', label: 'PM2.5 (µg/m³)', color: 'rgb(54, 162, 235)' },
                { id: 'o3', label: 'Ozone (ppb)', color: 'rgb(255, 159, 64)' },
                { id: 'temp', label: 'Temperature (°C)', color: 'rgb(255, 205, 86)' },
                { id: 'hum', label: 'Humidity (%)', color: 'rgb(75, 192, 192)' },
                { id: 'tvoc', label: 'TVOC (raw)', color: 'rgb(153, 102, 255)' }
            ];
            
            sensors.forEach(sensor => {
                const ctx = document.getElementById(sensor.id + 'Chart').getContext('2d');
                charts[sensor.id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: sensor.label,
                            data: [],
                            borderColor: sensor.color,
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            fill: false,
                            pointBackgroundColor: sensor.color,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    color: '#666'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    color: '#666',
                                    maxTicksLimit: 4,
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        },
                        elements: {
                            line: {
                                borderWidth: 3
                            }
                        }
                    }
                });
            });
        }
        
        // Fetch data from ESP32
        async function fetchData() {
            try {
                const response = await fetch('/data');
                const data = await response.json();
                
                // Update display with color coding
                updateSensorDisplay('co2', data.co2);
                updateSensorDisplay('pm25', data.pm25);
                updateSensorDisplay('o3', data.o3);
                updateSensorDisplay('temp', data.temp);
                updateSensorDisplay('hum', data.hum);
                updateSensorDisplay('tvoc', data.tvoc);
                
                // Update status
                const now = new Date();
                const timeDiff = (now - data.lastUpdate) / 1000;
                
                if (timeDiff < 30) {
                    document.getElementById('status').textContent = 'Online';
                    document.getElementById('status').className = 'status online';
                } else {
                    document.getElementById('status').textContent = 'Offline';
                    document.getElementById('status').className = 'status offline';
                }
                
                // Update chart data
                const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                dataPoints.timestamps.push(timeStr);
                dataPoints.co2.push(data.co2);
                dataPoints.pm25.push(data.pm25);
                dataPoints.o3.push(data.o3);
                dataPoints.temp.push(data.temp);
                dataPoints.hum.push(data.hum);
                dataPoints.tvoc.push(data.tvoc);
                
                // Keep only last 20 points
                if (dataPoints.timestamps.length > 20) {
                    Object.keys(dataPoints).forEach(key => {
                        if (dataPoints[key].length > 20) {
                            dataPoints[key].shift();
                        }
                    });
                }
                
                // Update all charts
                Object.keys(charts).forEach(sensor => {
                    charts[sensor].data.labels = dataPoints.timestamps;
                    charts[sensor].data.datasets[0].data = dataPoints[sensor];
                    charts[sensor].update('none');
                });
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('status').textContent = 'Error';
                document.getElementById('status').className = 'status error';
            }
        }
        
        // Initialize
        window.onload = function() {
            initCharts();
            fetchData();
            setInterval(fetchData, 5000); // Update every 5 seconds
        };
        
        // Fetch initial data for display
        fetch('/data')
          .then(response => response.json())
          .then(data => {
            document.getElementById('co2').textContent = data.co2;
            document.getElementById('pm25').textContent = data.pm25;
            document.getElementById('o3').textContent = data.o3;
            document.getElementById('temp').textContent = data.temp;
            document.getElementById('hum').textContent = data.hum;
            document.getElementById('tvoc').textContent = data.tvoc;
          });
    </script>
</body>
</html>